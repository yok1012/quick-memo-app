# QuickMemo ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»ç®¡ç†ä»•æ§˜æ›¸

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€QuickMemoã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«é–¢ã™ã‚‹å…¨ã¦ã®æŠ€è¡“ä»•æ§˜ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

## ç›®æ¬¡

1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [ãƒ‡ãƒ¼ã‚¿æ§‹é€ ](#2-ãƒ‡ãƒ¼ã‚¿æ§‹é€ )
3. [ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸](#3-ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)
4. [iCloudé€£æºï¼ˆProç‰ˆæ©Ÿèƒ½ï¼‰](#4-icloudé€£æºproç‰ˆæ©Ÿèƒ½)
5. [Watché€£æº](#5-watché€£æº)
6. [Widgeté€£æº](#6-widgeté€£æº)
7. [ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³](#7-ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
8. [ã‚¢ãƒ—ãƒªå‰Šé™¤æ™‚ã®å¯¾å¿œ](#8-ã‚¢ãƒ—ãƒªå‰Šé™¤æ™‚ã®å¯¾å¿œ)
9. [ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã®å¯¾å¿œ](#9-ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã®å¯¾å¿œ)
10. [ãƒ‡ãƒ¼ã‚¿å¾©æ—§æ©Ÿèƒ½](#10-ãƒ‡ãƒ¼ã‚¿å¾©æ—§æ©Ÿèƒ½)
11. [ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½](#11-ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½)
12. [åˆ¶é™äº‹é …](#12-åˆ¶é™äº‹é …)
13. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼](#13-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼)
14. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#14-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
15. [æŠ€è¡“çš„è©³ç´°](#15-æŠ€è¡“çš„è©³ç´°)

---

## 1. æ¦‚è¦

æœ¬ã‚¢ãƒ—ãƒªã¯**ã€Œã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ»é«˜é€Ÿèµ·å‹•ã€**ã‚’é‡è¦–ã—ã€ä¸»ãŸã‚‹ä¿å­˜é ˜åŸŸã¨ã—ã¦`UserDefaults`ï¼ˆApp Groupï¼‰ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚Proç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«ã¯CloudKitã‚’åˆ©ç”¨ã—ãŸ**ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒã€**å½¢å¼ã®ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã‚’æä¾›ã—ã¾ã™ã€‚

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§

| ä¿å­˜é ˜åŸŸ | æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ | ç›®çš„ | æ°¸ç¶šæ€§ |
|:---|:---|:---|:---|
| **ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆiOSï¼‰** | UserDefaults (App Group) | ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã€Widgetå…±æœ‰ | ã‚¢ãƒ—ãƒªå‰Šé™¤ã§æ¶ˆå¤± |
| **ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆWatchï¼‰** | UserDefaults (Standard) | Watchå˜ç‹¬å‹•ä½œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ã‚¢ãƒ—ãƒªå‰Šé™¤ã§æ¶ˆå¤± |
| **ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆProç‰ˆï¼‰** | CloudKit (Private DB) | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€æ©Ÿç¨®å¤‰æ›´æ™‚ã®å¾©å…ƒ | **æ°¸ç¶šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã™ã‚‹ã¾ã§ï¼‰** |
| **Core Data** | Core Data (SQLite) | ç¾åœ¨æœªä½¿ç”¨ãƒ»å°†æ¥ã®CloudKité€£æºç”¨ | ã‚¢ãƒ—ãƒªå‰Šé™¤ã§æ¶ˆå¤± |

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
    â†“
View (SwiftUI)
    â†“
DataManager (Singleton)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¿å­˜å…ˆ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ App Group     â”‚ CloudKit      â”‚ Core Data     â”‚
â”‚ UserDefaults  â”‚ (Proç‰ˆã®ã¿)   â”‚ (æœªä½¿ç”¨)      â”‚
â”‚ â€»å¿…é ˆ        â”‚ â€»ã‚ªãƒ—ã‚·ãƒ§ãƒ³  â”‚ â€»å°†æ¥ç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                   â†“
  Widget             iCloud
  Watch
```

---

## 2. ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯`Codable`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–æ‹ ã—ã€JSONã¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### 2.1 QuickMemoï¼ˆãƒ¡ãƒ¢ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `quickMemoApp/Models/DataModels.swift`

```swift
struct QuickMemo: Identifiable, Codable {
    let id: UUID                    // ä¸€æ„è­˜åˆ¥å­ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
    var title: String               // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºæ–‡å­—å¯ã€v1.1ã§è¿½åŠ ï¼‰
    var content: String             // ãƒ¡ãƒ¢å†…å®¹
    var primaryCategory: String     // ã‚«ãƒ†ã‚´ãƒªãƒ¼å
    var tags: [String]              // ã‚¿ã‚°é…åˆ—
    var createdAt: Date             // ä½œæˆæ—¥æ™‚
    var updatedAt: Date             // æ›´æ–°æ—¥æ™‚
    var calendarEventId: String?    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆIDï¼ˆé€£æºæ™‚ã®ã¿ï¼‰
    var durationMinutes: Int        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®æœŸé–“ï¼ˆåˆ†ï¼‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30
}
```

**å¾Œæ–¹äº’æ›æ€§**:
- `title`: å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ã¯ç©ºæ–‡å­—`""`ã¨ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰
- `durationMinutes`: å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ã¯`30`ã¨ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰

### 2.2 ArchivedMemoï¼ˆå‰Šé™¤å±¥æ­´ï¼‰

```swift
struct ArchivedMemo: Identifiable, Codable {
    let id: UUID                    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–IDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
    let originalMemo: QuickMemo     // å…ƒã®ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Œå…¨ä¿æŒï¼‰
    let deletedAt: Date             // å‰Šé™¤æ—¥æ™‚
}
```

### 2.3 Categoryï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰

```swift
struct Category: Identifiable, Codable {
    let id: UUID                    // ä¸€æ„è­˜åˆ¥å­ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
    var name: String                // ã‚«ãƒ†ã‚´ãƒªãƒ¼åï¼ˆãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºæ¸ˆã¿ï¼‰
    var icon: String                // SF Symbolsã‚¢ã‚¤ã‚³ãƒ³å
    var color: String               // è‰²ï¼ˆHEXå½¢å¼ã€ä¾‹: "007AFF"ï¼‰
    var order: Int                  // è¡¨ç¤ºé †åºï¼ˆ0å§‹ã¾ã‚Šï¼‰
    var defaultTags: [String]       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚°
    var isDefault: Bool             // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã©ã†ã‹
    var baseKey: String?            // ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºç”¨ãƒ™ãƒ¼ã‚¹ã‚­ãƒ¼ï¼ˆä¾‹: "work"ï¼‰
    var hiddenTags: Set<String>     // éè¡¨ç¤ºã‚¿ã‚°ã®ã‚»ãƒƒãƒˆ
}
```

**å¾Œæ–¹äº’æ›æ€§**:
- `isDefault`: å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ã¯`false`ã¨ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰
- `baseKey`: å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ã¯`nil`ã¨ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰
- `hiddenTags`: å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ã¯ç©ºã‚»ãƒƒãƒˆ`[]`ã¨ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰

### 2.4 CloudKitãƒ¬ã‚³ãƒ¼ãƒ‰æ§‹é€ 

#### DataBackupï¼ˆãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `deviceID` | String | ãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥å­ï¼ˆUDIDï¼‰ |
| `memosData` | Data | JSON encodedãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆISO8601æ—¥ä»˜ï¼‰ |
| `categoriesData` | Data | JSON encodedã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ |
| `memosCount` | Int64 | ãƒ¡ãƒ¢æ•° |
| `categoriesCount` | Int64 | ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•° |
| `lastBackupDate` | Date | æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥æ™‚ |
| `appVersion` | String | ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ |

**ãƒ¬ã‚³ãƒ¼ãƒ‰ID**: `backup_{deviceID}`

#### SubscriptionStatusï¼ˆè³¼å…¥çŠ¶æ…‹ï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `userIdentifier` | String | Sign in with Appleè­˜åˆ¥å­ |
| `transactionID` | String | StoreKitãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ID |
| `productID` | String | è³¼å…¥ã—ãŸå•†å“ID |
| `isPro` | Int64 | Proç‰ˆãƒ•ãƒ©ã‚°ï¼ˆ1 = Proï¼‰ |
| `lastUpdated` | Date | æœ€çµ‚æ›´æ–°æ—¥æ™‚ |
| `deviceID` | String | ãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥å­ |

**ãƒ¬ã‚³ãƒ¼ãƒ‰ID**: `subscription_{userIdentifier}`

---

## 3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

### 3.1 iOSï¼ˆApp Group UserDefaultsï¼‰

**Suiteå**: `group.yokAppDev.quickMemoApp`

App Groupã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã¨Widgeté–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã—ã¦ã„ã¾ã™ã€‚ã‚°ãƒ«ãƒ¼ãƒ—ãŒåˆ©ç”¨ã§ããªã„ç’°å¢ƒã§ã¯æ¨™æº–`UserDefaults`ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚

```swift
let appGroupIdentifier = "group.yokAppDev.quickMemoApp"
if let groupDefaults = UserDefaults(suiteName: appGroupIdentifier) {
    self.userDefaults = groupDefaults
} else {
    self.userDefaults = UserDefaults.standard  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
}
```

### UserDefaultsã‚­ãƒ¼ä¸€è¦§ï¼ˆApp Groupï¼‰

| ã‚­ãƒ¼ | èª¬æ˜ | ãƒ‡ãƒ¼ã‚¿å‹ |
|------|------|----------|
| `memos` | ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ | JSON encoded `[QuickMemo]` |
| `categories` | ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ | JSON encoded `[Category]` |
| `categoriesBackup` | ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— | JSON encoded `[Category]` |
| `archivedMemos` | å‰Šé™¤å±¥æ­´ | JSON encoded `[ArchivedMemo]` |
| `widgetCategories` | Widgetè¡¨ç¤ºã‚«ãƒ†ã‚´ãƒªãƒ¼ | JSON encoded `[String]` |
| `isProVersion` | Proç‰ˆãƒ•ãƒ©ã‚° | `Bool` |
| `firstLaunchCompleted` | åˆå›èµ·å‹•å®Œäº†ãƒ•ãƒ©ã‚° | `Bool` |
| `dataMigrated` | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ãƒ•ãƒ©ã‚° | `Bool` |
| `appVersion` | ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ | `String` |
| `isPurchased` | è³¼å…¥çŠ¶æ…‹ï¼ˆWatchå…±æœ‰ç”¨ï¼‰ | `Bool` |

### UserDefaultsã‚­ãƒ¼ä¸€è¦§ï¼ˆStandardï¼‰

| ã‚­ãƒ¼ | èª¬æ˜ | ãƒ‡ãƒ¼ã‚¿å‹ |
|------|------|----------|
| `lastCloudBackupDate` | æœ€çµ‚iCloudãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥æ™‚ | `Date` |
| `NotificationEnabled` | é€šçŸ¥æœ‰åŠ¹ãƒ•ãƒ©ã‚° | `Bool` |
| `NotificationInterval` | é€šçŸ¥é–“éš” | `Int` |
| `QuietModeStart` | ãŠã‚„ã™ã¿é–‹å§‹æ™‚åˆ» | `Date` |
| `QuietModeEnd` | ãŠã‚„ã™ã¿çµ‚äº†æ™‚åˆ» | `Date` |
| `app_language` | ã‚¢ãƒ—ãƒªè¨€èªè¨­å®š | `String` |
| `userIdentifier` | Sign in with Apple ID | `String` |
| `userEmail` | Sign in with Apple Email | `String` |
| `userName` | Sign in with Apple Name | `String` |
| `debugProMode` | ãƒ‡ãƒãƒƒã‚°Proæœ‰åŠ¹ï¼ˆDEBUGï¼‰ | `Bool` |

### ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿å‡¦ç†

**ä¿å­˜å‡¦ç†**:
```swift
func saveMemos() {
    if let data = try? JSONEncoder().encode(memos) {
        userDefaults.set(data, forKey: memosKey)
        notifyWidgetUpdate()
    }
    if iCloudSyncEnabled {
        Task { await saveMemosToCoreData() }
    }
}

func saveCategories() {
    do {
        let data = try JSONEncoder().encode(categories)
        userDefaults.set(data, forKey: categoriesKey)
        userDefaults.set(data, forKey: categoriesBackupKey)  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚åŒæ™‚ä¿å­˜
        userDefaults.synchronize()
        notifyWidgetUpdate()
    } catch { /* ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° */ }
}
```

**èª­ã¿è¾¼ã¿å‡¦ç†**:
```swift
func loadMemos() {
    if let data = userDefaults.data(forKey: memosKey),
       let decodedMemos = try? JSONDecoder().decode([QuickMemo].self, from: data) {
        memos = decodedMemos
    }
}
```

### 3.2 Core Dataï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `quickMemoApp/Services/CoreDataStack.swift`

Core Dataã‚¹ã‚¿ãƒƒã‚¯ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€ç¾åœ¨ã¯Proç‰ˆã§ã®ãƒŸãƒ©ãƒ¼ä¿å­˜ã®ã¿ã€‚å°†æ¥ã®CloudKitçµ±åˆã«å‚™ãˆã¦å±¥æ­´ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

```swift
// å±¥æ­´ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆå°†æ¥ã®CloudKitçµ±åˆã®ãŸã‚ï¼‰
description.setOption(true as NSNumber, forKey: NSPersistentHistoryTrackingKey)
```

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**:
- `QuickMemoEntity`: ãƒ¡ãƒ¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- `CategoryEntity`: ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

**ã‚¹ãƒˆã‚¢å ´æ‰€**: `Application Support/QuickMemoApp.sqlite`

---

## 4. iCloudé€£æºï¼ˆProç‰ˆæ©Ÿèƒ½ï¼‰

### 4.1 æ¦‚è¦

Proç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã€CloudKitï¼ˆPrivate Databaseï¼‰ã‚’åˆ©ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨è³¼å…¥çŠ¶æ…‹ã®åŒæœŸãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `quickMemoApp/Services/CloudKitManager.swift`

### 4.2 CloudKitè¨­å®š

- **ã‚³ãƒ³ãƒ†ãƒŠID**: `iCloud.yokAppDev.quickMemoApp`ï¼ˆBundle IDãƒ™ãƒ¼ã‚¹ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Private Databaseï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã€é–‹ç™ºè€…ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰

```swift
self.container = CKContainer.default()
self.privateDatabase = container.privateCloudDatabase
```

### 4.3 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ

#### è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

1. **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»è¡Œæ™‚**: `UIApplication.willResignActiveNotification`å—ä¿¡æ™‚
   - å‰å›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰1æ™‚é–“ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚Œã°å®Ÿè¡Œ
2. **Proç‰ˆè³¼å…¥å®Œäº†æ™‚**: å³æ™‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

```swift
NotificationCenter.default.addObserver(
    self,
    selector: #selector(appWillResignActive),
    name: UIApplication.willResignActiveNotification,
    object: nil
)
```

#### æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ

è¨­å®šç”»é¢ã‹ã‚‰å®Ÿè¡Œå¯èƒ½:
- `backupToiCloud()`: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’iCloudã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- `restoreFromiCloud()`: iCloudã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ

#### å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯

```swift
func restoreData() async -> (memos: [QuickMemo], categories: [Category])? {
    // 1. ç¾åœ¨ã®ãƒ‡ãƒã‚¤ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¤œç´¢
    let deviceID = UIDevice.current.identifierForVendor?.uuidString ?? "unknown"
    let recordID = CKRecord.ID(recordName: "backup_\(deviceID)")

    // 2. è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã®æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¤œç´¢
    let query = CKQuery(recordType: backupRecordType, predicate: NSPredicate(value: true))
    query.sortDescriptors = [NSSortDescriptor(key: "lastBackupDate", ascending: false)]

    // 3. JSONãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
}
```

### 4.4 è³¼å…¥çŠ¶æ…‹ã®åŒæœŸ

Sign in with Appleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã®ã¿å‹•ä½œ:

- **ãƒ­ãƒ¼ã‚«ãƒ«ãŒProã€CloudKitã«è¨˜éŒ²ãªã—**: CloudKitã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- **CloudKitã«Proè¨˜éŒ²ã‚ã‚Š**: ãƒ­ãƒ¼ã‚«ãƒ«ã‚’Proã«æ›´æ–°
- **ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆæ™‚**: `clearSubscriptionStatus()`ã§ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤

### 4.5 iCloudåŒæœŸã®æ¡ä»¶

```swift
// å¿…é ˆæ¡ä»¶
guard purchaseManager.isProVersion else { return false }  // Proç‰ˆã®ã¿

let accountStatus = await checkiCloudAccountStatus()
guard accountStatus == .available else { return false }   // iCloudã‚µã‚¤ãƒ³ã‚¤ãƒ³å¿…é ˆ
```

---

## 5. Watché€£æº

### 5.1 è¨­è¨ˆæ€æƒ³

| ãƒ‡ãƒã‚¤ã‚¹ | å½¹å‰² |
|---------|------|
| iPhone | ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ã‚¹ã‚ªãƒ–ãƒˆã‚¥ãƒ«ãƒ¼ã‚¹ï¼ˆä¿¡é ¼ã§ãã‚‹å˜ä¸€æƒ…å ±æºï¼‰ |
| Watch | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |

**ãƒ•ã‚¡ã‚¤ãƒ«**:
- iOSå´: `quickMemoApp/Services/iOSWatchConnectivityManager.swift`
- Watchå´: `quickMemoWatch Watch App/Services/WatchConnectivityManager.swift`
- Watchå´ãƒ‡ãƒ¼ã‚¿: `quickMemoWatch Watch App/Services/WatchDataManager.swift`

### 5.2 Watchã®ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«**: `quickMemoWatch Watch App/Models/WatchModels.swift`

iOSç‰ˆã‚ˆã‚Šè»½é‡åŒ–ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨:

```swift
struct WatchMemo: Identifiable, Codable {
    let id: UUID
    var title: String
    var content: String
    var category: String        // iOSç‰ˆã®primaryCategoryã«ç›¸å½“
    var createdAt: Date
    var tags: [String]
}

struct WatchCategory: Identifiable, Codable, Equatable {
    let id: UUID
    var name: String
    var icon: String
    var color: String
    var defaultTags: [String]
    var baseKey: String?
}
```

### 5.3 Watch UserDefaultsã‚­ãƒ¼

| ã‚­ãƒ¼ | èª¬æ˜ | ãƒ‡ãƒ¼ã‚¿å‹ |
|------|------|----------|
| `watchMemos` | Watchç”¨ãƒ¡ãƒ¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | JSON encoded `[WatchMemo]` |
| `watchCategories` | Watchç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | JSON encoded `[WatchCategory]` |
| `pendingMemos` | é€ä¿¡å¾…ã¡ãƒ¡ãƒ¢ã‚­ãƒ¥ãƒ¼ | `[[String: Any]]` |

### 5.4 åŒæœŸãƒ•ãƒ­ãƒ¼

#### iPhone â†’ Watch

```
iPhone (iOSWatchConnectivityManager)
    â†“
sendCategoriesToWatch() / sendMemosToWatch()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ°é”å¯èƒ½:  WCSession.sendMessage()  â”‚
â”‚ åˆ°é”ä¸å¯: transferUserInfo()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Watch (WatchConnectivityManager) ã§å—ä¿¡
    â†“
WatchDataManager ã«ä¿å­˜
```

**é‡è¦**: æœ€æ–°20ä»¶ã®ãƒ¡ãƒ¢ã®ã¿åŒæœŸï¼ˆWatchã®å®¹é‡ã‚’è€ƒæ…®ï¼‰

```swift
let memos = DataManager.shared.memos.prefix(20).map { ... }
```

#### Watch â†’ iPhone

```
Watch ã§ãƒ¡ãƒ¢ä½œæˆ
    â†“
WatchConnectivityManager.sendMemoToPhone()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ°é”å¯èƒ½:  WCSession.sendMessage()        â”‚
â”‚ åˆ°é”ä¸å¯: pendingMemos ã«è¿½åŠ ï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
iPhone (iOSWatchConnectivityManager) ã§å—ä¿¡
    â†“
DataManager.addMemo() ã§ä¿å­˜
```

### 5.5 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼

Watchã¯é€šä¿¡ã§ããªã„å ´åˆã€ãƒ¡ãƒ¢ã‚’`pendingMemos`é…åˆ—ã«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°:

```swift
private func storePendingMemo(_ memoData: [String: Any]) {
    pendingMemos.append(memoData)
    UserDefaults.standard.set(pendingMemos, forKey: "pendingMemos")
}

func syncPendingMemos() {
    guard !pendingMemos.isEmpty, WCSession.default.isReachable else { return }
    // ã‚­ãƒ¥ãƒ¼å†…ã®ãƒ¡ãƒ¢ã‚’é€ä¿¡...
}
```

æ¥ç¶šå¾©å¸°æ™‚ï¼ˆ`sessionReachabilityDidChange`ï¼‰ã«è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ã€‚

### 5.6 è³¼å…¥çŠ¶æ…‹ã®åŒæœŸ

```swift
// iPhoneã‹ã‚‰Watchã¸é€ä¿¡
let message: [String: Any] = [
    "type": "purchaseStatusUpdate",
    "isPro": isPro
]

// Watchã¯App Groupã«ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
if let sharedDefaults = UserDefaults(suiteName: "group.yokAppDev.quickMemoApp") {
    sharedDefaults.set(isPro, forKey: "isPurchased")
}
```

---

## 6. Widgeté€£æº

### 6.1 ãƒ‡ãƒ¼ã‚¿å…±æœ‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `quickMemoWidget/quickMemoWidget.swift`

App Group UserDefaultsã‚’ä½¿ç”¨ã—ã¦ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã¨Widgetã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã€‚
Widgetã¯**èª­ã¿å–ã‚Šå°‚ç”¨**ã§ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€è¿½åŠ ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯æŒã¡ã¾ã›ã‚“ã€‚

### 6.2 Widgetæ›´æ–°é€šçŸ¥

ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«Widgetã®æ›´æ–°ã‚’é€šçŸ¥:

```swift
private func notifyWidgetUpdate() {
    #if os(iOS)
    if #available(iOS 14.0, *) {
        WidgetCenter.shared.reloadAllTimelines()
    }
    #endif
}
```

### 6.3 è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒªãƒ¼è¨­å®šï¼ˆProç‰ˆï¼‰

```swift
func getWidgetCategories() -> [String]       // è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—
func saveWidgetCategories(_ categories: [String])  // è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒªãƒ¼ä¿å­˜
func canCustomizeWidgetCategories() -> Bool  // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã‹ï¼ˆProç‰ˆã®ã¿ï¼‰
```

Freeç‰ˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ4ä»¶ã‚’è¡¨ç¤ºã€‚

---

## 7. ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 7.1 è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«`DataManager.init()`ã§è‡ªå‹•å®Ÿè¡Œ:

```swift
init() {
    // 1. App Group UserDefaultsã®åˆæœŸåŒ–
    // 2. ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    migrateDataFromOldLocations()
    // 3. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    loadCategories()
    loadMemos()
    // 4. çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•ä¿®å¾©
    if categories.isEmpty && !memos.isEmpty {
        reconstructCategoriesFromMemos()
    }
}
```

### 7.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡

1. **æ¨™æº–UserDefaultsã‹ã‚‰App Groupã¸**
   - App Group entitlementè¿½åŠ å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ
   - å®Œäº†å¾Œ`dataMigrated`ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ

```swift
private func migrateFromStandardUserDefaults() -> Bool {
    let standard = UserDefaults.standard

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    if userDefaults.data(forKey: categoriesKey) == nil,
       let legacyData = standard.data(forKey: categoriesKey) {
        userDefaults.set(legacyData, forKey: categoriesKey)
        userDefaults.set(legacyData, forKey: categoriesBackupKey)
    }

    // ãƒ¡ãƒ¢ã€å‰Šé™¤å±¥æ­´ã€Widgetè¨­å®šã€ProçŠ¶æ…‹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³...
}
```

2. **ã‚«ãƒ†ã‚´ãƒªãƒ¼å†æ§‹ç¯‰**
   - ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒæ¶ˆå¤±ã—ãŸå ´åˆã€ãƒ¡ãƒ¢ã‹ã‚‰å†æ§‹ç¯‰

```swift
private func reconstructCategoriesFromMemos() {
    let categoryNames = Set(memos.map { $0.primaryCategory })
    for name in categoryNames {
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å†ä½œæˆ
    }
}
```

3. **æ—§ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å¤‰æ›**
   - æ—§ã€Œshoppingã€ã‚«ãƒ†ã‚´ãƒªã¯ã€Œpeopleã€ã«å¤‰æ›

```swift
private func migrateLegacyShoppingCategory() {
    // "shopping" â†’ "people" ã¸ã®å¤‰æ›å‡¦ç†
}
```

### 7.3 å¾Œæ–¹äº’æ›æ€§ã®ç¢ºä¿

ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ã§æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š:

```swift
init(from decoder: Decoder) throws {
    let container = try decoder.container(keyedBy: CodingKeys.self)
    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    id = try container.decode(UUID.self, forKey: .id)
    content = try container.decode(String.self, forKey: .content)

    // ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    title = try container.decodeIfPresent(String.self, forKey: .title) ?? ""
    durationMinutes = try container.decodeIfPresent(Int.self, forKey: .durationMinutes) ?? 30
    hiddenTags = try container.decodeIfPresent(Set<String>.self, forKey: .hiddenTags) ?? []
}
```

---

## 8. ã‚¢ãƒ—ãƒªå‰Šé™¤æ™‚ã®å¯¾å¿œ

### 8.1 ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒçŠ¶æ³

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | å‰Šé™¤å¾Œã®çŠ¶æ…‹ | å¾©æ—§æ–¹æ³• |
|-----------|-------------|---------|
| App Group UserDefaults | **å‰Šé™¤ã•ã‚Œã‚‹** | iCloudã‹ã‚‰å¾©å…ƒï¼ˆProç‰ˆï¼‰ |
| æ¨™æº–UserDefaults | **å‰Šé™¤ã•ã‚Œã‚‹** | å¾©æ—§ä¸å¯ |
| Core Data | **å‰Šé™¤ã•ã‚Œã‚‹** | å¾©æ—§ä¸å¯ |
| iCloudï¼ˆCloudKitï¼‰ | **ä¿æŒã•ã‚Œã‚‹** | å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«å¾©å…ƒ |
| ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ | **ä¿æŒã•ã‚Œã‚‹** | ã‚¢ãƒ—ãƒªã¨ã®é€£æºã¯åˆ‡ã‚Œã‚‹ |

### 8.2 å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®å¾©æ—§

**Proç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼**:
1. App Storeã‹ã‚‰è³¼å…¥ã‚’å¾©å…ƒ
2. iCloudãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰è‡ªå‹•å¾©å…ƒï¼ˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆï¼‰
3. ã¾ãŸã¯è¨­å®šç”»é¢ã‹ã‚‰æ‰‹å‹•å¾©å…ƒ

**ç„¡æ–™ç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼**:
- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯å¾©æ—§ä¸å¯
- **æ¨å¥¨**: å‰Šé™¤å‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—

### 8.3 CloudKitãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å‰Šé™¤

å®Œå…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ãŸã„å ´åˆ:
1. ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã§`SubscriptionStatus`ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤
2. è¨­å®šç”»é¢ï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰ã‹ã‚‰`deleteBackup()`ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤

---

## 9. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã®å¯¾å¿œ

### 9.1 ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒ

- UserDefaultsã®ãƒ‡ãƒ¼ã‚¿ã¯**ãã®ã¾ã¾ä¿æŒ**ã•ã‚Œã‚‹
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›´ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ã§å¸å

### 9.2 ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | å¯¾å¿œ |
|-----------|---------|------|
| v1.0 â†’ v1.1 | `title`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç©ºæ–‡å­— |
| v1.1 â†’ v1.2 | `hiddenTags`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç©ºã‚»ãƒƒãƒˆ |
| v1.2 â†’ v1.3 | `durationMinutes`è¿½åŠ  | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30åˆ† |

### 9.3 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªãƒ¼ã®è£œå®Œ

```swift
private func ensureDefaultCategoriesExist() {
    let defaultKeys = ["work", "personal", "idea", "people", "other"]
    for key in defaultKeys {
        if !categories.contains(where: { $0.baseKey == key }) {
            // ä¸è¶³ã—ã¦ã„ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ 
        }
    }
}
```

### 9.4 Proåˆ‡ã‚Šæ›¿ãˆæ™‚ã®å‹•ä½œ

- **Proã«ãªã£ãŸæ™‚ç‚¹**: å³æ™‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
- **Proå¤±åŠ¹æ™‚**: iCloudåŒæœŸã‚’åœæ­¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã¯ç¶™ç¶šï¼‰

---

## 10. ãƒ‡ãƒ¼ã‚¿å¾©æ—§æ©Ÿèƒ½

### 10.1 è‡ªå‹•å¾©æ—§ï¼ˆèµ·å‹•æ™‚ï¼‰

```swift
// ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¶ˆå¤±æ™‚ã®è‡ªå‹•ä¿®å¾©
if categories.isEmpty && !memos.isEmpty {
    reconstructCategoriesFromMemos()
}

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©å…ƒ
if categories.isEmpty {
    attemptCategoryRecovery()  // categoriesBackupã‚­ãƒ¼ã‹ã‚‰å¾©å…ƒ
}
```

### 10.2 æ‰‹å‹•å¾©æ—§ï¼ˆè¨­å®šç”»é¢ã‹ã‚‰ï¼‰

`attemptFullDataRecovery()`ãƒ¡ã‚½ãƒƒãƒ‰:

```swift
func attemptFullDataRecovery() -> (categories: Int, memos: Int) {
    // 1. è¤‡æ•°ã®UserDefaultsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³
    let possibleSuiteNames = [
        "group.yokAppDev.quickMemoApp",
        "yokAppDev.quickMemoApp",
        "com.yokAppDev.quickMemoApp"
    ]

    // 2. ä»¶æ•°ãŒå¤šã„ã‚‚ã®ã‚’æ¡ç”¨
    // 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚­ãƒ¼ã‹ã‚‰ã®å¾©å…ƒ
    // 4. å‰Šé™¤å±¥æ­´ã‹ã‚‰ã®ãƒ¡ãƒ¢å¾©å…ƒ
    // 5. ãƒ¡ãƒ¢ã‹ã‚‰ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼å†æ§‹ç¯‰
}
```

---

## 11. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½

**ãƒ•ã‚¡ã‚¤ãƒ«**: `quickMemoApp/Services/ExportManager.swift`

### 11.1 å¯¾å¿œå½¢å¼

| å½¢å¼ | æ‹¡å¼µå­ | ç‰¹å¾´ |
|------|--------|------|
| CSV | `.csv` | Excelã§é–‹ã‘ã‚‹ã€UTF-8 BOMä»˜ã |
| JSON | `.json` | å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä¿æŒ |

### 11.2 ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç¨®åˆ¥

| ãƒ¡ã‚½ãƒƒãƒ‰ | å¯¾è±¡ | ãƒ•ã‚¡ã‚¤ãƒ«å |
|---------|------|-----------|
| `exportMemos()` | ç¾åœ¨ã®ãƒ¡ãƒ¢ | `QuickMemo_YYYYMMDD_HHmmss.csv/json` |
| `exportArchivedMemos()` | å‰Šé™¤å±¥æ­´ | `QuickMemo_Archive_YYYYMMDD_HHmmss.csv/json` |
| `exportAllData()` | å…¨ãƒ‡ãƒ¼ã‚¿ | `QuickMemo_All_YYYYMMDD_HHmmss.csv/json` |

### 11.3 ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

#### CSVå½¢å¼

```csv
ID,ã‚¿ã‚¤ãƒˆãƒ«,å†…å®¹,ã‚«ãƒ†ã‚´ãƒªãƒ¼,ã‚¿ã‚°,ä½œæˆæ—¥æ™‚,æ›´æ–°æ—¥æ™‚,ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆID,æœŸé–“(åˆ†)
uuid-string,ã‚¿ã‚¤ãƒˆãƒ«,ãƒ¡ãƒ¢å†…å®¹,ä»•äº‹,tag1;tag2,2024-01-01T00:00:00Z,...
```

**æ³¨æ„**: UTF-8 BOMä»˜ãã§Excelã§ã®æ—¥æœ¬èªè¡¨ç¤ºã«å¯¾å¿œ

#### JSONå½¢å¼

```json
{
  "exportDate": "2024-01-01T00:00:00Z",
  "version": "1.0",
  "memos": [
    {
      "id": "uuid-string",
      "title": "ã‚¿ã‚¤ãƒˆãƒ«",
      "content": "ãƒ¡ãƒ¢å†…å®¹",
      "category": "ä»•äº‹",
      "tags": ["tag1", "tag2"],
      "timestamp": "2024-01-01T00:00:00Z",
      "lastModified": "2024-01-01T00:00:00Z",
      "calendarEventId": null,
      "durationMinutes": 30
    }
  ]
}
```

### 11.4 ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```swift
func importMemos(from url: URL) throws -> [QuickMemo]
// - JSON/CSVä¸¡å¯¾å¿œ
// - æ‹¡å¼µå­ã§è‡ªå‹•åˆ¤åˆ¥
```

**å‡ºåŠ›å…ˆ**: `FileManager.default.temporaryDirectory`ï¼ˆä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã€æ°¸ç¶šä¿å­˜ã¯ã—ãªã„ï¼‰

---

## 12. åˆ¶é™äº‹é …

### 12.1 Freeç‰ˆã®åˆ¶é™

| é …ç›® | Freeç‰ˆ | Proç‰ˆ |
|------|--------|-------|
| ãƒ¡ãƒ¢æ•° | 100ä»¶ | ç„¡åˆ¶é™ |
| ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•° | 5ä»¶ | ç„¡åˆ¶é™ |
| ãƒ¡ãƒ¢ã‚ãŸã‚Šã®ã‚¿ã‚°æ•° | 15ä»¶ | ç„¡åˆ¶é™ |
| iCloudåŒæœŸ | ãªã— | ã‚ã‚Š |
| Widgetã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º | ãªã— | ã‚ã‚Š |

### 12.2 æŠ€è¡“çš„åˆ¶é™

| é …ç›® | åˆ¶é™ | å‚™è€ƒ |
|------|------|------|
| UserDefaultsã‚µã‚¤ã‚º | ç´„1MB | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã®ç›®å®‰ |
| WatchåŒæœŸãƒ¡ãƒ¢æ•° | 20ä»¶ | æœ€æ–°ã®ã‚‚ã®ã‚’å„ªå…ˆ |
| CloudKitã‚¯ã‚©ãƒ¼ã‚¿ | Appleè¦å®š | Private DBã¯æ¯”è¼ƒçš„ä½™è£•ã‚ã‚Š |
| ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–“éš” | 1æ™‚é–“ | è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æœ€å°é–“éš” |

---

## 13. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼

### 13.1 æš—å·åŒ–

- **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿**: iOSãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æš—å·åŒ–ã§ä¿è­·ï¼ˆãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯æ™‚ï¼‰
- **CloudKit**: Appleã‚µãƒ¼ãƒãƒ¼ä¸Šã§æš—å·åŒ–ã€é–‹ç™ºè€…ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼ˆPrivate DBï¼‰

### 13.2 ãƒ‡ãƒ¼ã‚¿åé›†

- ã‚¢ãƒ—ãƒªç‹¬è‡ªã®ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯**ä¸€åˆ‡ãªã—**
- å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®iCloudã«ä¿å­˜

### 13.3 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº

- EventKitã‚’ä½¿ç”¨
- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦
- ã‚¤ãƒ™ãƒ³ãƒˆIDã®ã¿ã‚’ãƒ¡ãƒ¢ã«ä¿å­˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿è‡ªä½“ã¯ã‚³ãƒ”ãƒ¼ã—ãªã„ï¼‰
- ãƒ¡ãƒ¢å‰Šé™¤æ™‚ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚‚å‰Šé™¤ã™ã‚‹å ´åˆã¯`CalendarService.deleteCalendarEvent`ã‚’å‘¼ã³å‡ºã™

---

## 14. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 14.1 ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãŸå ´åˆ

1. **è¨­å®š > ãƒ‡ãƒ¼ã‚¿å¾©æ—§**ã‚’å®Ÿè¡Œ
2. **è¨­å®š > iCloudã‹ã‚‰å¾©å…ƒ**ï¼ˆProç‰ˆï¼‰
3. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

### 14.2 Watchã¨åŒæœŸã•ã‚Œãªã„å ´åˆ

1. iPhoneã®Watchã‚¢ãƒ—ãƒªã§ãƒšã‚¢ãƒªãƒ³ã‚°çŠ¶æ…‹ã‚’ç¢ºèª
2. ä¸¡æ–¹ã®ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•
3. Watchã‚¢ãƒ—ãƒªã§ã€ŒåŒæœŸã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€

### 14.3 iCloudãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå¤±æ•—ã™ã‚‹å ´åˆ

1. iCloudã®ç©ºãå®¹é‡ã‚’ç¢ºèª
2. iCloudã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª
4. è¨­å®š > Apple ID > iCloud ã§ã‚¢ãƒ—ãƒªã®æ¨©é™ã‚’ç¢ºèª

### 14.4 ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ç¢ºèª

```swift
// DataManagerèµ·å‹•ãƒ­ã‚°
ğŸ”´ =====================================
ğŸ”´ DataManager init() called
ğŸ”´ =====================================
âœ… Using App Group UserDefaults: group.yokAppDev.quickMemoApp
ğŸ“Š After load: 5 categories
ğŸ“Š After load: 10 memos
ğŸ“‹ DataManager initialization complete

// CloudKitãƒ‡ãƒãƒƒã‚°
CloudKitManager.shared.printDebugInfo()
// Container ID, Sync Status, Last Backup Date ãªã©ã‚’å‡ºåŠ›
```

---

## 15. æŠ€è¡“çš„è©³ç´°

### 15.1 é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `quickMemoApp/Models/DataModels.swift` | ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®šç¾© |
| `quickMemoApp/Services/DataManager.swift` | ãƒ‡ãƒ¼ã‚¿æ“ä½œã®ä¸­å¿ƒã‚¯ãƒ©ã‚¹ |
| `quickMemoApp/Services/CloudKitManager.swift` | iCloudé€£æº |
| `quickMemoApp/Services/CoreDataStack.swift` | Core Dataç®¡ç†ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰ |
| `quickMemoApp/Services/ExportManager.swift` | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ |
| `quickMemoApp/Services/iOSWatchConnectivityManager.swift` | iOSå´ã®Watché€šä¿¡ |
| `quickMemoApp/Services/CalendarService.swift` | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº |
| `quickMemoApp/Services/AuthenticationManager.swift` | Sign in with Apple |
| `quickMemoWatch Watch App/Services/WatchConnectivityManager.swift` | Watchå´ã®é€šä¿¡ |
| `quickMemoWatch Watch App/Services/WatchDataManager.swift` | Watchå´ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç† |
| `quickMemoWatch Watch App/Models/WatchModels.swift` | Watchç”¨è»½é‡ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« |

### 15.2 é€šçŸ¥å

| é€šçŸ¥å | ç”¨é€” |
|--------|------|
| `PurchaseStatusChanged` | è³¼å…¥çŠ¶æ…‹å¤‰æ›´æ™‚ |
| `OpenPurchaseView` | Watchâ†’iPhoneè³¼å…¥ç”»é¢è¡¨ç¤º |
| `OpenSettingsView` | Watchâ†’iPhoneè¨­å®šç”»é¢è¡¨ç¤º |

### 15.3 è­˜åˆ¥å­ä¸€è¦§

| è­˜åˆ¥å­ | å€¤ |
|--------|-----|
| App Group | `group.yokAppDev.quickMemoApp` |
| Bundle ID | `yokAppDev.quickMemoApp` |
| CloudKit Container | `iCloud.yokAppDev.quickMemoApp` |

---

## é‹ç”¨ä¸Šã®æ³¨æ„

1. **Freeç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼**: ãƒ‡ãƒã‚¤ã‚¹ç´›å¤±æ™‚ã®å¾©å…ƒæ‰‹æ®µãŒãªã„ãŸã‚ã€é‡è¦ãƒ‡ãƒ¼ã‚¿ã¯å®šæœŸçš„ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ¨å¥¨

2. **CloudKitãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: ç«¯æœ«å˜ä½ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãŸã‚ã€å¤§é‡ç«¯æœ«ã§ä½¿ç”¨ã™ã‚‹ã¨æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä»–ç«¯æœ«ã®ã‚‚ã®ã«ãªã‚‹å¯èƒ½æ€§ã‚ã‚Š

3. **ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ¨©é™ã«ä¾å­˜ã€ãƒ¡ãƒ¢å‰Šé™¤æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œãªã„ï¼ˆæ˜ç¤ºçš„ã«`deleteCalendarEvent`å‘¼ã³å‡ºã—ãŒå¿…è¦ï¼‰

4. **ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã‚‹ãŸã‚ã€å…±æœ‰å¾Œã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹
